---
title: "Systematic review and climate change analysis in Los Lagos Region"
author: "Derek Corcoran"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    toc: false
bibliography: Biblio.bib
header-includes:
    - \usepackage[round]{natbib}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, cache = T, error = F)

library(ggrepel)
library(patchwork)
library(raster)
library(scales)
library(sf)
library(tidyverse)
library(kableExtra)
```


```{r data, include=FALSE}
Carpeta_results <- paste0(getwd(), "/Climate_Results/")

### Circulo para GCMComparer

circle <- read_rds(paste0(Carpeta_results,"Circle.rds"))


## Tabla de GCMs

table_scaled <- readRDS(paste0(Carpeta_results,"table_scaled.rds"))

BestNumbers <- function(x, Digits = 2, BigSep = ",", Pre = NULL){
  x <- prettyNum(round(x, digits = Digits), big.mark = BigSep)
  if(!is.null(Pre)){
    x <- paste(Pre, x)
  }
  return(x)
}

AndList <-  function(x, Sep = "and"){
  x <- sort(x)
  First <- paste(x[-length(x)], collapse = ", ")
  Second <- x[length(x)]
  return(paste(First, Second, sep = str_pad(Sep, str_count(Sep) + 2, "both")))
}

Regiones <- read_rds("Regiones.rds")

GCMs <- list.files(path = "ChelsaData/Future") %>% str_remove_all("_rcp85.rds")
```

# Climate change analisis

```{r Crops, cache = T}
### Leer presente

Presente <- read_rds("ChelsaData/Present/Presente.rds") %>% crop(Regiones)

Presente <- Presente  %>% 
  mask(rasterize(Regiones, Presente[[1]]))

Presente <- Presente[[c("Bio1", "Bio12")]]
  
Presente[["Bio1"]] <- Presente[["Bio1"]]/10 

Futuros <- list.files(path = "ChelsaData/Future", full.names = T) %>% purrr::map(read_rds) %>%
purrr::map(~crop(.x, Regiones))

Futuros <- Futuros  %>% purrr::map(~mask(.x, rasterize(Regiones, Presente[[1]])))

Futuros <- Futuros %>% purrr::map(~.x[[c("Bio1", "Bio12")]]) 

for(i in 1:length(Futuros)){
  Futuros[[i]][["Bio1"]] <- Futuros[[i]][["Bio1"]]/10
}

Difs <- Futuros %>% purrr::map(~ .x - Presente)

Dif_Temp <- Difs %>% purrr::map(~.x[["Bio1"]]) %>% reduce(stack)

Dif_Prec <- Difs %>% purrr::map(~.x[["Bio12"]]) %>% reduce(stack)

PNLagos_Rios <- readRDS("~/Documents/CI_Project/PNLagos.rds") %>% dplyr::filter(NAME %in% c("Vicente Perez Rosales", "Puyehue", "Alerce Andino"))

hull <- PNLagos_Rios %>% sf::st_union() %>% st_transform(crs = "+proj=tcea +lon_0=-74.7070313 +datum=WGS84 +units=m +no_defs") %>% st_buffer(10000) %>% st_convex_hull() %>% st_transform("+proj=longlat +datum=WGS84 +no_defs") %>% st_as_sf()
```

## Climate change in southern Chile

In order to evaluate possible scenarios of climate change in the given area, we used a polygon comprising the Los Lagos and Los Ríos regions in Chile, and compared them using GCM compareR [@fajardo2020gcm], considering Mean Anual Temperature and Annual Precipitation. The resulting scaled table of comparisson among futures was then use to select models to be used in the project.

We used the simple structure index (ssi) as implemented by the Vegan package [@Oksanen_2019; @dolnicar1999tale] to test what number of clusters (Between two and eight), was the best way to represent the 32 Compared GCMs. The best representation was five clusters, from each cluster the GCM closest to the centroid of the cluster was selected. The five selected GCMS were `r AndList(table_scaled %>% dplyr::filter(GCM != "") %>% pull(GCM))` and the selected GCMs together with the clusters are shown in figure \@ref(fig:SelectedGCMs). 


```{r SelectedGCMs, fig.cap="In this graph we can see the scaled temperature and precipitation axis, the center of the graph represent the ensemble of all models, the five groups represent the clusters selected using kmeans for five groups, the selected GCM of each cluster is shown with a label"}
ggplot(table_scaled, aes(x = x_axis, y = y_axis)) + 
  geom_point(aes(color = Group)) +
  geom_path(data = circle, aes(x = x, y = y)) + 
  coord_equal() +
  geom_text_repel(aes(label = GCM), nudge_y = 0.3) + 
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  theme_bw() +
  labs(x = "Scaled Temperature Axis",
       y = "Scaled Precipitation Axis")
```

### Present climate conditions

Once the future GCM models were selected, the 30 seconds resolution maps were downloaded for 2070 and for present conditons from CHELSA [@karger2020high].
The present conditions for the Los Lagos and Los Ríos Region are shown in Figure \@ref(fig:PresenteClima), with a close up to the 10 Km buffer surrounding the park in \@ref(fig:PresenteClimaBuffer). The region is a cold and humid area, with a range in the mean annual temperature from `r round(cellStats(Presente[[1]], min), 2)` to `r round(cellStats(Presente[[1]], max), 2)` degrees Celsius and a mean of `r round(cellStats(Presente[[1]], mean), 2)`, and a precipitation range between `r round(cellStats(Presente[[2]], min), 2)` to `r prettyNum(round(cellStats(Presente[[2]], max)),big.mark =",")` and a mean of `r prettyNum(round(cellStats(Presente[[2]], mean)),big.mark = ",")` mm a year. 

```{r PresenteClima, fig.cap= "Mean anual temperature in °C (Facet A), and Annual Precipitation mm (Facet B)", out.width = "100%", out.height="100%"}
Presente_DF <- Presente %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

G1 <- ggplot() + geom_raster(data = Presente_DF, aes(x = x, y = y, fill = Bio1)) + geom_sf(data = Regiones, alpha = 0, size = 0.1) + geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.1) + geom_sf(data = hull, color = "red", alpha = 0, size = 0.1)+ theme_bw(base_size = 8) + scale_fill_gradient2(name = str_wrap("Mean Annual Temperature [°C]", width = 18), high = muted("red"),
  mid = "white",
  low = muted("blue"),
  midpoint = 0) + labs(x = NULL, y = NULL) + scale_x_continuous(breaks =c(-75:-72))

G2 <- ggplot() + geom_raster(data = Presente_DF, aes(x = x, y = y, fill = Bio12)) + geom_sf(data = Regiones, alpha = 0, size = 0.1) + geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.1)+ geom_sf(data = hull, color = "red", alpha = 0, size = 0.1) + theme_bw(base_size = 8) + scale_fill_viridis_c(name = str_wrap("Annual Precipitation [mm]", 18)) + labs(x = NULL, y = NULL) + scale_x_continuous(breaks =c(-75:-72)) 

G1 + G2 + plot_annotation(tag_levels = 'A')
```

```{r}
Presente_Hull <- Presente %>% crop(hull) 

Presente_Hull <-  Presente_Hull %>% mask(rasterize(hull, Presente_Hull[[1]]))

Presente_Hull_DF <- Presente_Hull %>%  as("SpatialPixelsDataFrame") %>% as.data.frame()
```


The parks concidered in this proyect are in high altitude which leads to even cooler and wetter conditions, with a range from `r BestNumbers(cellStats(Presente_Hull[[1]], min))` to `r BestNumbers(cellStats(Presente_Hull[[1]], max))` and a mean of `r BestNumbers(cellStats(Presente_Hull[[1]], mean))` degrees Celsius, and a precipitation range from from `r BestNumbers(cellStats(Presente_Hull[[2]], min))` to `r BestNumbers(cellStats(Presente_Hull[[2]], max))` and a mean of `r BestNumbers(cellStats(Presente_Hull[[2]], mean))` mm as seen in figure \@ref(fig:PresenteClimaBuffer).

```{r PresenteClimaBuffer, fig.cap= "Mean anual temperature in °C (Facet A), and Annual Precipitation mm (Facet B) in the three studied national parks white lines, and a 10 km buffer red line", out.width = "100%", out.height="100%"}


G1 <- ggplot() + geom_raster(data = Presente_Hull_DF, aes(x = x, y = y, fill = Bio1)) + geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.1) + geom_sf(data = hull, color = "red", alpha = 0, size = 0.1)+ theme_bw(base_size = 8) + scale_fill_gradient2(name = str_wrap("Mean Annual Temperature [°C]", width = 18), high = muted("red"),
  mid = "white",
  low = muted("blue"),
  midpoint = 0) + labs(x = NULL, y = NULL) + scale_x_continuous(breaks =seq(-72.8, -71.8, by = 0.4))

G2 <- ggplot() + geom_raster(data = Presente_Hull_DF, aes(x = x, y = y, fill = Bio12)) + geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.1)+ geom_sf(data = hull, color = "red", alpha = 0, size = 0.1) + theme_bw(base_size = 8) + scale_fill_viridis_c(name = str_wrap("Annual Precipitation [mm]", 18)) + labs(x = NULL, y = NULL)+ scale_x_continuous(breaks =seq(-72.8, -71.8, by = 0.4)) 

G1 + G2 + plot_annotation(tag_levels = 'A')
```

## Future scenarios

### Future temperature

```{r DifTemp, fig.cap= "Changes in future  mean annual temperature for the five selected GCMs, the red polygon surrounds the area of influence while the white line  demarks the limits of the three protected areas in this proyect"}
names(Dif_Temp) <- GCMs
names(Dif_Prec) <- GCMs

Dif_Temp_DF <- Dif_Temp %>% as("SpatialPixelsDataFrame") %>% 
  as.data.frame() %>% 
  pivot_longer(CESM1.BGC:MPI.ESM.LR, names_to = "GCM", values_to = "Temperature")

ggplot() + geom_raster(data =Dif_Temp_DF, aes(x = x, y = y, fill = Temperature)) + geom_sf(data = Regiones, alpha = 0, size = 0.1) + geom_sf(data= hull, alpha = 0, size = 0.1, color = "red") + geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.1) + facet_wrap(~GCM) + scale_fill_viridis_c(option = "inferno") + labs(x = NULL, y = NULL) + scale_x_continuous(breaks =c(-74:-72)) + theme_bw(base_size = 8)
```

As stated above, the four GCMs chosen to explore and model future scenarios are `r AndList(table_scaled %>% dplyr::filter(GCM != "") %>% pull(GCM))`. Even when this models include relatively wetter models such as `r table_scaled %>% dplyr::filter(GCM != "") %>% dplyr::filter(y_axis == max(y_axis)) %>% pull(GCM)`. On average for the whole region, the temperature will rise from `r BestNumbers(min(cellStats(Dif_Temp, mean)))` to `r BestNumbers(max(cellStats(Dif_Temp, mean)))` depending on the GCM (See figure \@ref(fig:DifTemp)), but in some areas, it the tempearture rise could be as high as `r BestNumbers(max(cellStats(Dif_Temp, max)))` degrees Celsius.

As seen in figure \@ref(fig:DifTempHull), those changes are even higher within the parks and it's sorrounding areas, which means the effects of climate change might be even greater.

```{r DifTempHull, fig.cap="Temperature difference for all five GCMs, for the Close up of the area of influence of the parks"}
Dif_Temp_Hull <- Dif_Temp %>% crop(hull) 

Dif_Temp_Hull <-  Dif_Temp_Hull %>% mask(rasterize(hull, Presente_Hull[[1]]))

Dif_Temp_Hull_DF <- Dif_Temp_Hull %>%  as("SpatialPixelsDataFrame") %>% as.data.frame() %>% pivot_longer(CESM1.BGC:MPI.ESM.LR, names_to = "GCM", values_to = "Temperature")

ggplot() + geom_raster(data =Dif_Temp_Hull_DF, aes(x = x, y = y, fill = Temperature)) + geom_sf(data= hull, alpha = 0, size = 0.1, color = "red") + geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.1) + facet_wrap(~GCM) + scale_fill_viridis_c(option = "inferno") + labs(x = NULL, y = NULL) + scale_x_continuous(breaks =seq(-72.8, -71.8, by = 0.4)) + theme_bw(base_size = 8)
```

### Future precipitation


The change in precipitation is predicted to be much more stark, with some areas decreasing in precipitation up to `r BestNumbers(min(cellStats(Dif_Prec, min)))` as seen in figure \@ref(fig:DifPrec), this is particularly worrisome, since the ecosystems that are prevalent in the area depend on high precipitation.

```{r DifPrec, fig.cap= "Changes in precipitation for the different GCMs, the red polygon surrounds the area of influence while the white line  demarks the limits of the three protected areas in this proyect"}
Dif_Prec_DF <- Dif_Prec %>% as("SpatialPixelsDataFrame") %>% 
  as.data.frame() %>% 
  pivot_longer(CESM1.BGC:MPI.ESM.LR, names_to = "GCM", values_to = "Precipitation")

ggplot() + geom_raster(data =Dif_Prec_DF, aes(x = x, y = y, fill = Precipitation)) + geom_sf(data = Regiones, alpha = 0, size = 0.1) + geom_sf(data= hull, alpha = 0, size = 0.1, color = "red") + geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.1) + facet_wrap(~GCM) + scale_fill_viridis_c() + labs(x = NULL, y = NULL) + scale_x_continuous(breaks =c(-74:-72)) + theme_bw(base_size = 8)
```





```{r DifPrecHull, fig.cap ="Precipitation difference for all five GCMs, for the Close up of the area of influence of the parks"}

Dif_Prec_Hull <- Dif_Prec %>% crop(hull) 

Dif_Prec_Hull <-  Dif_Prec_Hull %>% mask(rasterize(hull, Presente_Hull[[1]]))

Dif_Prec_Hull_DF <- Dif_Prec_Hull %>%  as("SpatialPixelsDataFrame") %>% as.data.frame() %>% pivot_longer(CESM1.BGC:MPI.ESM.LR, names_to = "GCM", values_to = "Precipitation")

ggplot() + geom_raster(data =Dif_Prec_Hull_DF, aes(x = x, y = y, fill = Precipitation)) + geom_sf(data= hull, alpha = 0, size = 0.1, color = "red") + geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.1) + facet_wrap(~GCM) + scale_fill_viridis_c() + labs(x = NULL, y = NULL) + scale_x_continuous(breaks =seq(-72.8, -71.8, by = 0.4)) + theme_bw(base_size = 8)
```

The range of changes between GCMs will be from from `r BestNumbers(min(cellStats(Dif_Prec, mean)))` to `r BestNumbers(max(cellStats(Dif_Prec, mean)))` mean annual precipitation for the whole area. Again the areas where there is going to be a higher drop in precipitation are mostly inside of the national parks, as seen in figure \@ref(fig:DifPrecHull), with changes in the mean annual precipitation within the are of `r BestNumbers(min(cellStats(Dif_Prec_Hull, mean)))` for the wettest models, and `r BestNumbers(max(cellStats(Dif_Prec_Hull, mean)))` for the driest models.

## Vegetational formation

```{r}

Formation_Change <- read_rds("Formation_Change.rds")
```


We used @luebert2009depuracion to check current vegetational formations as seen in figure \@ref(fig:VegHull)

```{r VegHull, fig.cap= "Vegetational formation in the influence area of the parks"}
Pisos_hull <- read_rds("Pisos_hull.rds")

Pisos_hull <- Pisos_hull %>% mutate(PISO = str_wrap(PISO, width = 20))

ggplot() + geom_sf(data = Pisos_hull, aes(fill = PISO), size = 0.01) +  geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.5)+ theme(legend.position = "bottom") + scale_fill_viridis_d(name = "Vegetation") + theme_bw(base_size = 8) + scale_x_continuous(breaks =seq(-72.8, -71.8, by = 0.4))
```

### Climatic analogues

As seen above, changes in precipitation will be very large. Because of that, we checked which areas in the present have the same climate as it is predicted to be in the future in the national parks and sorrounding areas using the analouges R package [@ramirez2011climate]. After doing that, the current vegetational formations of those areas were checked in order to determine possible future vegetation in the area. With that we might better understand the biological consecuences of climate change.
  
```{r}
  NewFormations <- Formation_Change %>% pivot_longer(cols = -c("Rank")) %>% 
    dplyr::filter(!(value %in% Formation_Change$Present)) %>% pull(value) %>% unique()
  
  Desapeared <- Formation_Change %>% pivot_longer(cols = -c("Rank")) %>% 
    dplyr::filter(name != "Present") %>% pull(value) %>% unique()
  
Desapeared <- Formation_Change$Present[!(Formation_Change$Present %in% Desapeared)]
```


Currently in the National Parks and sorrouding areas, the five most common Vegetational formations are `r AndList(Formation_Change$Present)`, and in the future, new vegetational formations that would be part of the five most common ones would include `r AndList(NewFormations)`. Of the current five most common formations, the ones that would be reduced as far as that they would either be lost completely or become very rare are `r AndList(Desapeared)`

```{r TablaForm}
Formation_Change <- read_rds("Formation_Change.rds") %>% mutate_all(~str_wrap(.x, width = 8))

kable(Formation_Change, booktabs = T, caption = "Top five vegetation formations for the present and for the different GCMs acording to the analogous climate analysis") %>% kable_styling(font_size = 5, full_width = F)
```


## Land use

We used @zhao2016detailed landuse layer, specifically developed for Chile. This is a 30 meter resolution, that 

```{r}

Codes <- read_csv("https://raw.githubusercontent.com/derek-corcoran-barrios/UsosDeSueloChile/master/Codes.csv")

LandUse <- raster("/home/derek/Documents/El_Soldado/LC_CHILE_2014_b.tif")

Seldom_Hull <- hull %>% st_transform("+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs")

LandUse <- LandUse %>% crop(Seldom_Hull)

LandUse <- LandUse %>% mask(rasterize(Seldom_Hull, LandUse)) 

LandUse2 <- projectRaster(from = LandUse, to = Presente_Hull[[1]], method = "ngb")

LandUse_DF <- LandUse2 %>% as("SpatialPixelsDataFrame") %>% 
  as.data.frame() %>% 
  rename(Code = LC_CHILE_2014_b) %>% 
  left_join(Codes) %>% 
  dplyr::filter(!is.na(Primary_English))


ggplot() + geom_raster(data =LandUse_DF, aes(x = x, y = y, fill =Primary_English)) + scale_fill_viridis_d(name = "Primary landuse") + labs(x = NULL, y = NULL) +
  geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.5) + scale_x_continuous(breaks =seq(-72.8, -71.8, by = 0.4)) + theme_bw(base_size = 8)
```


```{r}
ggplot() + geom_raster(data =LandUse_DF, aes(x = x, y = y, fill =Secondary_English)) + scale_fill_viridis_d(name = "Secondary landuse") + labs(x = NULL, y = NULL) +
  geom_sf(data = PNLagos_Rios, alpha = 0, color = "white", size = 0.5) + scale_x_continuous(breaks =seq(-72.8, -71.8, by = 0.4)) + theme_bw(base_size = 8)
```


```{r}
LandUse_DF2 <- LandUse_DF %>% group_by(Primary_English) %>%
    summarise(n= n()) %>% 
  mutate(Percentage = round(100*(n/sum(n)),2)) %>% 
  dplyr::select(-n) %>% 
  arrange(desc(Percentage)) %>% 
  rename(`Primary landuse` = Primary_English) %>%
  dplyr::filter(Percentage >= 1)

kable(LandUse_DF2, booktabs = T) %>% kable_styling()
```

```{r}
LandUse_DF3 <- LandUse_DF %>% group_by(Secondary_English) %>%
    summarise(n= n()) %>% 
  mutate(Percentage = round(100*(n/sum(n)),2)) %>% 
  dplyr::select(-n) %>% 
  arrange(desc(Percentage)) %>% 
  rename(`Secondary landuse` = Secondary_English) %>%
  dplyr::filter(Percentage >= 1)

kable(LandUse_DF3, booktabs = T) %>% kable_styling()
```


# References